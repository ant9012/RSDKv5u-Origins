name: Build RSDKv5U (MSYS2 + Fixes)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    defaults:
      run:
        shell: msys2 {0}  # CRITICAL: This runs all steps inside the MinGW environment

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false

    # 1. SETUP ENVIRONMENT (The Official Method)
    # We install the exact libraries the repo needs so CMake finds them 
    # and DOES NOT try to compile them from the missing source folders.
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW32  # We use 32-bit MinGW as requested by the repo
        update: true
        install: >-
          git
          make
          mingw-w64-i686-toolchain
          mingw-w64-i686-cmake
          mingw-w64-i686-libogg
          mingw-w64-i686-libvorbis
          mingw-w64-i686-libtheora
          mingw-w64-i686-tinyxml2

    # 2. MANUAL FIX FOR TINYXML2
    # Even with MSYS2, this fork often hardcodes the path to TinyXML2 source.
    # We clone it just in case to prevent the "Cannot find tinyxml2.cpp" error.
    - name: Fix TinyXML2
      run: |
        mkdir -p dependencies/all/tinyxml2
        git clone https://github.com/leethomason/tinyxml2.git dependencies/all/tinyxml2 || true

    # 3. CONFIGURE CMAKE
    # We use "MinGW Makefiles" generator because we are in MSYS2 now.
    - name: Configure CMake
      run: cmake -G "MinGW Makefiles" -B build -DRETRO_REVISION=3 -DCMAKE_BUILD_TYPE=Release

    # 4. BUILD
    - name: Build
      run: cmake --build build

    # 5. UPLOAD
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RSDKv5U-Windows
        path: build/*.exe
