name: Build RSDKv5U (Steal Dependencies)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. Checkout YOUR code (the fork you want to compile)
    - name: Checkout Main Code
      uses: actions/checkout@v4
      with:
        path: main_source

    # 2. Checkout the PARENT code (thesupersonic16) just to get the working dependencies
    - name: Checkout Dependency Source
      uses: actions/checkout@v4
      with:
        repository: thesupersonic16/RSDKv5u-Origins
        submodules: recursive
        path: dep_source

    # 3. Move the working dependencies into your source folder
    - name: Move Dependencies
      shell: bash
      run: |
        echo "Moving dependencies from parent repo..."
        # Remove any empty dependency folders in your repo
        rm -rf main_source/dependencies
        
        # Copy the fully populated dependencies folder from the parent repo
        cp -r dep_source/dependencies main_source/dependencies
        
        # Verify the file causing the error exists now
        if [ -f "main_source/dependencies/android/libtheora/lib/cpu.c" ]; then
            echo "cpu.c found! The fix worked."
        else
            echo "Warning: cpu.c still missing, but attempting build anyway..."
        fi

    # 4. Configure CMake (using your source code)
    - name: Configure CMake
      run: cmake -B build -DRETRO_REVISION=3
      working-directory: main_source

    # 5. Build
    - name: Build
      run: cmake --build build --config Release
      working-directory: main_source

    # 6. Upload
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RSDKv5U-Windows
        path: main_source/build/Release/*.exe
